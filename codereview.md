# Code review — плохо, дорого, не нужно (в большинстве случаев)

Code review я перевожу как «ревизия кода» и дальше буду использовать именно термин «ревизия кода».

Попытаюсь разобраться в процессном инструменте «ревизия кода», понять его границы применимости.

## Ревизия кода для поиска дефектов

Изначально, в 60-х, ревизия кода осуществлялась потому, что цикл «загрузил код — выполнил — проверил результат его работы» был огромен и дорог. Время компьютеров стоило сильно дороже времени программистов.

Цикл «загрузил код — выполнил — проверил результаты» состоял из следующих шагов:
- напечатали код на пишмашинке
- отдали операторам в набор
- операторы набрали в перфокарты
- ночью загрузили в считыватель перфокарт
- запустили код
- проинспектировали результаты тестовых расчётов
- если что-то пошло не так, загрузили набор перфокарт предыдущей версии кода и код возвращался на доработку

Думаю, достаточно очевидна причина появления фазы «инспекция кода» и её место в цикле.

В то время ревизия кода совершалась группами программистов (не 1 ревьювер, а много), и это всё равно оказывалось экономически эффективно, ведь цикл обнаружения ошибки и её последующего исправления была чрезвычайно долог и дорог.

Проблемы социальных динамик (обсуждаемые ниже) при сравнительно низкой цене программистов были малоинтересны.

Вопрос обучения и распространения знаний о коде тоже не стоял так резко. Программист, написавший некорректный код, вполне себе дообучался сам или с помощью коллег.

С течением времени время компьютеров становилось дешевле, программистов дороже. Цикл «загрузил код — выполнил — проверил результаты» стал короче и дешевле в большинстве случаев.

В некоторых случаях (прошивки «железа», например) цикл «загрузил — выполнил — проверил результаты» сократился, но несущественно.

Получается, что для целей обнаружения ошибок со временем ревизия кода становится всё менее экономически целесообразной.

Где-то к концу 80-х вопрос экономической нецелесообразности групповой ревизии кода встаёт в сообществе, многие компании начинают переходить к практике ревизии кода в малых группах или даже 1-1.

В 1996 году публикуется работа авторов A. Porter, H. Siy, и L. Votta — [A review of software inspections](https://www.sciencedirect.com/science/article/pii/S0065245808604842), в которой авторы составили таксономию подходов к ревизии кода и анализируют экономическую целесообразность разных подходов.

Вывод, к которому пришли авторы:

> At the global level we see that software inspection is still an effective method for detecting and removing defects.
> However, whether it is cost-effective remains to be seen.

К концу прошлого тысячелетия осталось совсем мало отраслей, где цикл «загрузил код — выполнил — проверил результаты» оставался дороже, чем время программистов, затрачиваемое на ревизию кода. С другой стороны, стало появляться всё больше автоматизированных средств выявления дефектов:
- компиляторы и интерпретаторы выдавали всё больше информации
- линтеры и статические анализаторы становились всё лучше
- юнит, интеграционные и функциональные тесты отрабатывали всё быстрее
- отладчики работали все лучше
- получили физическую возможность и распространение практики парного проектирования и программирования

Таким образом, кажется, что уже к 2000 экономического обоснования использования процесса ревизии кода для обнаружения дефектов почти не осталось.

К нулевым индустрия пережила огромный приток инвестиций и кадров, и, соответственно, общий уровень управленческой компетенции неизбежно снизился.

Огромный поток бывших инженеров, не занимавшихся организацией процессов производства, но бывших субъектами и участниками этих процессов, стали играть управленческие роли.

Неизбежным кажется и их слепое копирование тех практик, которые они использовали ранее в современные процессы производства ПО, порой без какого-либо критического осмысления.

Например, интересно, что в вышедшей в 2013 году статья товарищи авторы Alberto Bacchelli и Christian Bird — [Expectations, Outcomes, and Challenges of Modern Code Review, 2013](https://sback.it/publications/icse2013.pdf), резюмируют:

> Our results show that, although the top motivation driving code reviews is finding defects, the practice and the actual outcomes are less about finding errors than expected: Defect related comments comprise a small proportion and mainly cover small logical low-level issues.

Как мы видим, к 2013 году у специалистов начинает формироваться понимание, что использование ревизии кода для поиска дефектов уже не имеет ни экономической целесообразности, ни фактической.

При этом до сих пор в индустрии массово используется ревизия кода в блокирующем формате — когда для того, чтобы код оказался в системе, нужно получить формальное согласование коллеги-ревизора.

Чтобы проверить экономический эффект от использования ревизии кода для обнаружения дефектов, проведите простые подсчёты.

## Как посчитать

Типовой сценарий процесса выпуска кода с ревизией выглядит так:
- написанный код сдали на ревизию
- **... ожидание ревизии ...**
- происходит ревизия кода
- код возвращается на доработку
- **... ожидание доработки ...**
- происходит доработка кода, код снова передаётся на ревизию

Этот сценарий — оптимистичен, в нём всего один цикл доработки.

У вас наверняка есть статистика по времени нахождения задачи в каждом из приведённых статусов, посчитайте среднее время, потребное на прохождение этих статусов.

Дальше возьмите набор последних ревизий и обратите внимание, какие дефекты были обнаружены. Сформулируйте их критичность.

Потом попробуйте представить, какими другими, более дешёвыми процессными решениями можно было бы обнаружить эти дефекты.

Если руководитель проводит такое исследование, чаще всего оказывается, что инструмент ревизии кода нецелесообразен. При этом очень часто в такой момент сознание руководителя, иррационально держащееся за привычки, делает «финт», и внезапно ревизия кода уже «не только для дефектов, но и для обучения».

Понятно, что во фразе «не только для дефектов» подразумевается на самом деле «совсем не для дефектов».

## Ревизия кода как инструмент обучения


## Ссылки

- [A review of software Inspections, Porter, Siy, Votta, 1996](https://www.researchgate.net/publication/222504163_A_Review_of_Software_Inspections)
- [Expectations, Outcomes, and Challenges of Modern Code Review, 2013](https://sback.it/publications/icse2013.pdf)
- [Investigating technical and non-technical factors influencing modern code review, 2015](https://link.springer.com/article/10.1007%2Fs10664-015-9366-8)
